name: prod

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/shared-lint.yaml
    secrets: inherit

  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/shared-unit-tests.yaml
    secrets: inherit

  deploy-resources:
    name: Deploy SAM Resources
    needs: [lint, unit-tests]
    uses: ./.github/workflows/shared-deploy.yaml
    with:
      ENVIRONMENT: prod
      AWS_REGION: us-east-1
      PIPELINE_EXECUTION_ROLE: arn:aws:iam::965116670064:role/aws-sam-cli-managed-dev-pipel-PipelineExecutionRole-bh15tJwqwU3Y
      CLOUDFORMATION_EXECUTION_ROLE: arn:aws:iam::965116670064:role/aws-sam-cli-managed-dev-p-CloudFormationExecutionRo-2wGr0NBpJggH
      ARTIFACTS_BUCKET_NAME: aws-sam-cli-managed-dev-pipeline-r-artifactsbucket-zavpnflsqd1t
      STACK_NAME: my-great-app
    secrets: inherit

  test-api:
    name: Test API
    needs: [deploy-resources]
    uses: ./.github/workflows/shared-test-api.yaml
    with:
      ENVIRONMENT: prod
      AWS_REGION: us-east-1
      PIPELINE_EXECUTION_ROLE: arn:aws:iam::965116670064:role/aws-sam-cli-managed-dev-pipel-PipelineExecutionRole-bh15tJwqwU3Y
      STACK_NAME: my-great-app
    secrets: inherit
